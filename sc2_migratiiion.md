 

###   
**SCD Type 2 –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏¬ª, –∞ **–ø—Ä–æ—Ü–µ—Å—Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π** –∏–∑ OLTP-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, PostgreSQL) –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Parquet –≤ S3 –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É –≤ Greenplum).

---


#### 1. **–ò—Å—Ç–æ—á–Ω–∏–∫ (PostgreSQL)**  
–î–æ–ø—É—Å—Ç–∏–º, —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `clients`:
```sql
id | name  | segment    | updated_at
1  | –ò–≤–∞–Ω  | Standard   | 2026-01-10
```
‚Üí –ù–æ **–≤ OLTP –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏**: –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–µ–≥–º–µ–Ω—Ç–∞ `segment` –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è, –∞ `updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

#### 2. **–¶–µ–ª—å (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)**  
–¢–∞–±–ª–∏—Ü–∞ `dim_client_scd2`:
```text
client_id | name | segment | valid_from | valid_to   | is_current
1         | –ò–≤–∞–Ω | Standard| 2025-01-01 | 2026-01-26 | false
1         | –ò–≤–∞–Ω | Premium | 2026-01-27 | 9999-12-31 | true
```

#### 3. **–ö–∞–∫ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SCD2?**

##### –®–∞–≥ A: **–í—ã—è–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è**
- –ó–∞–ø–æ–º–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Airflow: `{{ ds }}` –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `etl_log`).
- –í—ã–±–µ—Ä–∏ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ `updated_at > last_migration_time`.

##### –®–∞–≥ B: **–°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π –≤ DWH**
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:
  - –ï—Å–ª–∏ `segment` **–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è** ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.
  - –ï—Å–ª–∏ **–∏–∑–º–µ–Ω–∏–ª—Å—è** ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å SCD2-–ª–æ–≥–∏–∫—É.

> üí° –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ Python (pandas) –∏–ª–∏ SQL (JOIN –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏ DWH).

##### –®–∞–≥ C: **–û–±–Ω–æ–≤–∏—Ç—å DWH**
- –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å (`valid_to = –≤—á–µ—Ä–∞`, `is_current = false`)
- –í—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é (`valid_from = —Å–µ–≥–æ–¥–Ω—è`, `is_current = true`)

##### –®–∞–≥ D: **–ó–∞–ø–∏—Å–∞—Ç—å –≤ Parquet / Greenplum**
- –í Parquet: –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä—É–π –ø–æ `valid_from` –∏–ª–∏ `client_id`.
- –í Greenplum: –∏—Å–ø–æ–ª—å–∑—É–π distribution key –ø–æ `client_id`.

---

###  
> ¬´–ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ PostgreSQL –≤ Parquet —è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª –ª–æ–≥–∏–∫—É, –±–ª–∏–∑–∫—É—é –∫ SCD Type 2. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã–≥—Ä—É–∂–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ `updated_at`). –í Python —è —Å—Ä–∞–≤–Ω–∏–≤–∞–ª –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–µ–π –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ï—Å–ª–∏ —Å–µ–≥–º–µ–Ω—Ç –º–µ–Ω—è–ª—Å—è ‚Äî —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø–æ–º–µ—á–∞–ª–∞—Å—å –∫–∞–∫ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–∞—è. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–ª–æ —Å—Ç—Ä–æ–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö¬ª.

 
---
 –ø—Å–µ–≤–¥–æ–∫–æ–¥ (–∏–ª–∏ SQL + Python) –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ç–∞–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏. 
---
–û—Ç–ª–∏—á–Ω–æ, –ò–ª—å—è. –í–æ—Ç **–º–∏–Ω–∏-–∑–∞–¥–∞—á–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –±–ª–∏–∑–∫–æ–º –∫ —Ç–≤–æ–µ–π —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ**:  
–º–∏–≥—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ PostgreSQL –≤ Parquet —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **SCD Type 2** ‚Äî –≤—Å—ë, —á—Ç–æ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

---

###  –¶–µ–ª—å —Ü–∏–∫–ª–∞:
–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ **–æ–¥–∏–Ω –¥–µ–Ω—å** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `2026-01-27`) –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É (`dim_client_scd2`), —Å–æ—Ö—Ä–∞–Ω—è—è –∏—Å—Ç–æ—Ä–∏—é.

---

###

**–ò—Å—Ç–æ—á–Ω–∏–∫ (PostgreSQL):**  
–¢–∞–±–ª–∏—Ü–∞ `clients` (OLTP):
```sql
id | name  | segment    | updated_at
1  | –ò–≤–∞–Ω  | Premium    | 2026-01-27 10:00:00  -- –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–µ–≥–æ–¥–Ω—è
2  | –ú–∞—Ä–∏—è | Standard   | 2026-01-25           -- –Ω–µ –º–µ–Ω—è–ª–∞—Å—å
```

**–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Parquet / –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ –ø–∞–º—è—Ç–∏):**  
–§–∞–π–ª `dim_client_scd2.parquet` (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ 2026-01-26):
```text
client_id | name  | segment  | valid_from | valid_to   | is_current
1         | –ò–≤–∞–Ω  | Standard | 2025-01-01 | 9999-12-31 | true
```

---

### –ü—Å–µ–≤–¥–æ–∫–æ–¥ + Python/SQL (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, –∫–∞–∫ –≤ Airflow)

```python
# 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ Airflow: {{ ds }})
run_date = "2026-01-27"

# 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (PostgreSQL)
changed_clients = pg_query(f"""
    SELECT id, name, segment, updated_at
    FROM clients
    WHERE DATE(updated_at) = '{run_date}'
""")

# 3. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é dim_client_scd2 (–∏–∑ Parquet)
current_dim = read_parquet("s3://my-bucket/dim_client_scd2.parquet")
# –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ is_current = True
active_dim = current_dim[current_dim["is_current"] == True]

# 4. –ù–∞–π—Ç–∏, —É –∫–æ–≥–æ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–µ–≥–º–µ–Ω—Ç
to_update = []
for row in changed_clients:
    client_id = row["id"]
    new_segment = row["segment"]
    
    # –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –≤ DWH
    current_record = active_dim[active_dim["client_id"] == client_id]
    
    if not current_record.empty:
        old_segment = current_record.iloc[0]["segment"]
        if old_segment != new_segment:
            # –¢—Ä–µ–±—É–µ—Ç—Å—è SCD2-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            to_update.append({
                "client_id": client_id,
                "old_segment": old_segment,
                "new_segment": new_segment,
                "name": row["name"]
            })

# 5. –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: –∑–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–µ, –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ
updates = []
for item in to_update:
    # –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
    updates.append({
        "client_id": item["client_id"],
        "name": item["name"],
        "segment": item["old_segment"],
        "valid_from": current_record["valid_from"].iloc[0],
        "valid_to": day_before(run_date),  # '2026-01-26'
        "is_current": False
    })
    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
    updates.append({
        "client_id": item["client_id"],
        "name": item["name"],
        "segment": item["new_segment"],
        "valid_from": run_date,           # '2026-01-27'
        "valid_to": "9999-12-31",
        "is_current": True
    })

# 6. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å: —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏, –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ
new_dim = current_dim.copy()
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ç–µ—Ö, –∫–æ–≥–æ –æ–±–Ω–æ–≤–ª—è–µ–º
ids_to_replace = [u["client_id"] for u in to_update]
new_dim = new_dim[~(
    (new_dim["client_id"].isin(ids_to_replace)) & 
    (new_dim["is_current"] == True)
)]
# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
new_dim = pd.concat([new_dim, pd.DataFrame(updates)], ignore_index=True)

# 7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –≤ Parquet
write_parquet(new_dim, "s3://my-bucket/dim_client_scd2.parquet")
```

---



 
